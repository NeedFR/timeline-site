{% extends "timeline/base.html" %}

{% block title %}
  {% if tl %}
    编辑事件 {{tl}}
  {% endif %}
{% endblock %}

{% block extra_header %}
{{block.super}}
<style type="text/css">
  #sb_tl_creater {
    overflow: hidden;
  }
  #sb_tl_creater .user {
    float: left;
  }
  #sb_tl_creater .info ul {
    list-style: none;
    margin: 0 0 0 44px;
  }
  #container_top .sw .label {
    font-size: inherit;
  }
  #container_top .sw {
    float: right;
  }
  .content hr {
    margin: 5px 0;
  }
  textarea {
    height: 120px;
  }
  #id_media, #id_media_caption {
    height: 20px;
  }
  #tl_form_div {
    display: none;
  }
  #btn_add_event {
    float: right;
  }
  .event.cover {
    font-weight: bold;
  }
</style>
<style type="text/css">
  #insert_tl_img.popover.bottom .arrow {
    left: 80px;
    border-bottom-color: #C6C6C6;
  }
  #insert_tl_img .popover-tab {
    padding: 4px 6px 0 6px;
    background-color:#F0F0F0;
  }
  #insert_tl_img .popover-inner {
    background-color:#C6C6C6;
    padding: 1px;
    border-radius: 0;
  }
  #insert_tl_img .popover-content {
    border-radius: 0;
  }
  #insert_tl_img .popover-tab p {
    margin: 0px;
  }
  #insert_tl_img .popover-tab p a {
    display: inline-block;
    height: 26px;
    line-height: 26px;
    margin: 0 -2px;
    padding: 0 11px;
    position: relative;
    z-index: 1;
  }
  #insert_tl_img .popover-tab .current {
    text-decoration: none;
    cursor: default;
    background: white;
    border: 1px solid #E8E8E8;
    border-bottom: 0;
    -moz-border-radius-topright: 3px;
    -webkit-border-top-right-radius: 3px 3px;
    -moz-border-radius-topleft: 3px;
    -webkit-border-top-left-radius: 3px 3px;
  }
  #fileupload {
    margin: 0;
  }
</style>
{% endblock %}

{% block sidebar %}
{% endblock %}

{% block container_top %}
<div id="container_top">
  <ul class="sbreadcrumb">
    <li><a href="{% url idx %}">首页</a> <span class="divider">/</span></li>
    <li><a href="{% url timeline_detail tl.pk %}">{{ tl.title }}</a> <span class="divider">/</span></li>
    <li class="active">编辑事件</li>
  </ul>
</div>
{% endblock %}

{% block content %}
  <div class="">
    <div class="">
      <div id="tl_list">
        <table class="table table-striped tllist" style="width=100%">
          <thead>
            <tr>
              <th style="width: 40px"></th>
              <th style="width: 160px">日期</th>
              <th style="width: 260px">标题</th>
              <th>说明</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
        <!-- loadding -->
        <a href="###" class="btn" id="btn_add_event">添加</a>
      </div>
    </div>

    <div class="" id="tl_form_div">
      <div style="width: 640px;float:left;">
        <form action="{% url timeline_addevent_ tl.pk %}" id="tl_form" enctype="multipart/form-data" method="post" class="form-horizontal">
          <fieldset>
            {% csrf_token %}
            <input type="hidden" id="id_pk_" />
            {{form.as_div}}
            <div class="form-actions" class="form-horizontal">
              <p>
                <button type="submit" class="btn btn-primary" id="id_btn_save">保存</button>
                <button type="submit" class="btn" id="id_btn_save_more">保存并继续添加</button>
                <button type="button" id="btn_tlf_cancel" class="btn cancel">取消</button>
              </p>
            </div>
          </fieldset>
        </form>
      </div>
      <div style="">
        .........................................................................
        .........................................................................
        .........................................................................
      </div>
    </div>
  </div>

  <div id="insert_tl_img" class="popover fade bottom in">
    <div class="arrow"> </div>
    <div class="popover-inner">
      <div class="popover-tab" >
        <a class="close" href="###" onclick="$('#insert_tl_img').hide()">×</a>
        <p>
          <a href="###" class="current">some</a>
          <a href="###">more</a>
        </p>
      </div>
      <div class="popover-content">
        <div> 
          <form id="fileupload" action="" method="POST" enctype="multipart/form-data">
            <div class="fileupload-buttonbar">
              <div>
                <span class="btn fileinput-button">
                  <i class="icon-upload"></i>
                  <span>上传图片</span>
                  <input type="file" name="file">
                </span>
                &nbsp;
              </div>
              <div>
                <p style="padding-bottom: 10px">
                  <img src="{{STATIC_URL}}img/loading.gif" />
                  文件上传中
                </p>
                <button type="reset" class="btn cancel">
                  <i class="icon-ban-circle"></i>
                  <span>取消上传</span>
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block footer_ext %}
  {{ block.super }}
  <script type="text/html" id="events_row_tmpl">
    <tr class="event <% if (cover) { %>cover<% } %>" id="e_<%=pk%>">
      <td>
        <a href="###" class="del">
          <i class="icon-remove"></i>
        </a>
        <a href="###" class="edit">
          <i class="icon-pencil"></i>
        </a>
      </td>
      <td>
        <%=startdate%> 
        <% if (enddate != '') { %> ~ <%=startdate%> <% } %>
      </td>
      <td>
        <%=title%>
        <i class="icon-<%=mediaType%>"></i>
      </td>
      <td><%=text%></td>
    </tr>
  </script>
  <link rel="stylesheet" href="{{STATIC_URL}}bootstrap-datepicker/datepicker.css" type="text/css"/>
  <link rel="stylesheet" href="{{ STATIC_URL }}jQuery-File-Upload/css/jquery.fileupload-ui.css" type="text/css"/>
  <script src='{{STATIC_URL}}js/simple-tpl.js' type='text/javascript'></script>
  <script src='{{STATIC_URL}}bootstrap/js/bootstrap.min.js' type='text/javascript'></script>
  <script type="text/javascript" src="{{ STATIC_URL }}ajax_validation/js/jquery-bootstrap-form.js"></script>
  <script type="text/javascript" src="{{ STATIC_URL }}ajax_validation/js/jquery.djangoajaxform.js"></script>
  <script type="text/javascript" src="{{ STATIC_URL }}bootstrap-datepicker/bootstrap-datepicker.js"></script>
  <script type="text/javascript" src="{{ STATIC_URL }}js/jquery.autosize-min.js"></script>

  <script src="{{ STATIC_URL }}jQuery-File-Upload/js/vendor/jquery.ui.widget.js"></script>
  <script src="{{ STATIC_URL }}jQuery-File-Upload/js/jquery.iframe-transport.js"></script>
  <script src="{{ STATIC_URL }}jQuery-File-Upload/js/jquery.fileupload.js"></script>
  <script src="{{ STATIC_URL }}jQuery-File-Upload/js/jquery.fileupload-fp.js"></script>
  <script src="{{ STATIC_URL }}jQuery-File-Upload/js/jquery.fileupload-ui.js"></script>
  <script src="{{ STATIC_URL }}jQuery-File-Upload/js/locale.js"></script>

  <script type='text/javascript'>
    $(function () {
      var tl_tb_body = $('#tl_list table.tllist tbody');
      var save_more = false;//save and add other
      function getMediaType(d) {
        if (d.match("div class='twitter'")) {
          //return "twitter-ready";
          return 'twitter'
        } else if (d.match('(www.)?youtube|youtu\.be')) {
          //return "youtube";
          return "film";
        } else if (d.match('(player.)?vimeo\.com')) {
          //return "vimeo";
          return "film";
        } else if (d.match('(player.)?soundcloud\.com')) {
          //return "soundcloud";
          return "music";
        } else if (d.match('(www.)?twitter\.com')) {
          return "twitter";
        } else if (d.match("maps.google") && !d.match("staticmap")) {
          //return "google-map";
          return "map-marker";
        } else if (d.match("flickr.com/photos")) {
          //return "flickr";
          return "picture";
        } else if (d.match(/jpg|jpeg|png|gif/i) || d.match("staticmap")) {
          //return "image";
          return "picture";
        } else if (d.indexOf('http://') == 0) {
          //return "website";
          return "globe";
        } else {
          return "unknown";
        }
      }
      function safeHtml(s) {
        return $('<div/>').text(s).html().replace(/\n/g, "<br />");
      }
      function genRow(d) {
        d.mediaType = getMediaType(d.media);
        d.title = safeHtml(d.title);
        d.text = safeHtml(d.text);
        d.media = safeHtml(d.media);
        d.media_caption = safeHtml(d.media_caption);
        return tmpl("events_row_tmpl", d);
      }
      function showForm() {
        $('#id_title')[0].focus();
        $('#tl_form_div').fadeIn('slow');
        $('#btn_add_event').fadeOut('slow');
        ;
        if ($('#id_pk_').val() == '') {
          $('#id_btn_save_more').show();
        } else {
          $('#id_btn_save_more').hide();
        }
      }
      function hideForm() {
        $('#tl_form_div').fadeOut('slow');
        $('#btn_add_event').fadeIn('slow');
      }
      $('#tl_form').djangoajaxform({
          callback: bootstrapCallback,
          removeErrorHints: bootstrapRemoveErrorHints,
          onValidateSucc: function(data, form){
            if (data.valid) {
              var pk = $('#id_pk_').val();
              if (pk == '') {
                tl_tb_body.append(genRow(data.data));
                initActBtn();
              } else {
                var row = $('#e_' + pk);
                row.fadeOut('slow', function(){
                  var nrow = $(genRow(data.data));
                  if (nrow.hasClass('cover')) {
                    $('tr', tl_tb_body).removeClass('cover');
                  }
                  row.html(nrow.html()).fadeIn('slow');
                  row.attr('class', nrow.attr('class'));
                  initActBtn();
                });
              }
              if (save_more) {
                $('#tl_form')[0].reset();
              } else {
                hideForm();
              }
            }
          }
      });

      /*
      $('#id_startdate,#id_enddate').datepicker({
        weekStart: 1,
        format: 'yyyy-mm-dd'
      }).on('changeDate', function(ev){
        $(this).datepicker('hide');
      });*/

      function initActBtn() {
        var del_btns = $(".event .del", tl_tb_body);
        var edit_btns = $(".event .edit", tl_tb_body);
        del_btns.unbind('click')
        edit_btns.unbind('click')
        del_btns.click(function(){
          if (!confirm('确定删除？')) return false;
          var p = $(this).parent().parent();
          var pk = p[0].id.split('_')[1]
          $.getJSON("{% url event_delete_ %}", {'pk': pk}, function(data) {
            if (data.valid) {
              p.fadeOut('slow', function(){p.remove()});
            } else {
              alert('删除失败');
            }
          });
        });
        edit_btns.click(function(){
          var p = $(this).parent().parent();
          var pk = p[0].id.split('_')[1]
          $('#id_pk_').val(pk);
          $('#tl_form').attr('action', "{% url event_edit_ %}?pk=" + pk);
          $('#tl_form_div').fadeOut('slow');
          $.getJSON("{% url event_json_ %}", {'pk': pk}, function(data) {
            if (data.valid) {
              formLoadData($('#tl_form'), data.data);
              showForm();
            } else {
              alert('数据加载失败');
            }
          });

        });
      }
      $('#btn_add_event').click(function(){
        $('#id_pk_').val('');
        $('#tl_form').attr('action', "{% url timeline_addevent_ tl.pk %}");
        $('#tl_form')[0].reset();
        showForm();
      });
      $('#btn_tlf_cancel').click(function(){
        hideForm();
      });
      $('#id_btn_save_more').click(function(){
        save_more = true;
      });
      $('#id_btn_save').click(function(){
        save_more = false;
      });
      function formLoadData(form, data, field_map, pre) {
        if (pre == undefined) pre = '';
        $.each(data, function(k, v){
          if (v instanceof Object) {
            formLoadData(form, data, field_map, pre + k + '_');
          } else {
            var fid = pre + k;
            if (field_map != undefined)
              var tfid = field_map[fid];
            if (tfid!=undefined) {
              fid = tfid;
            } else {
              fid = 'id_' + fid;
            }
            var f = $('#' + fid, form);
            if (f.attr('type') == 'checkbox') {
              f.attr('checked', v);
            } else {
              $('#' + fid, form).val(v);
            }
          }
        });
      }
      $('textarea').autosize();
      $.getJSON("{% url timeline_events_sjson_ tl.pk %}", {}, function(data) {
        $.each(data, function(i, d){
          tl_tb_body.append(genRow(d));
        });
        initActBtn();
      });
    });
  </script>
  <script type="text/javascript">
    $(function () {
      var upload = $('#fileupload');
      // Initialize the jQuery File Upload widget:
      upload.fileupload();

      // Demo settings:
      upload.fileupload('option', {
          url: "{% url attachments_ajax_upload %}",
          autoUpload: true,
          limitMultiFileUploads: 1,
          maxFileSize: 500000,
          acceptFileTypes: /(\.|\/)(gif|jpe?g|png)$/i,
          process: [ {
              action: 'load',
              fileTypes: /^image\/(gif|jpeg|png)$/,
              maxFileSize: 500000
          },
          {
            action: 'save'
          } ]
      });
      upload
      .bind('fileuploadadded', function (e, data) {
        $.each(data.files, function (index, file) {
          if (file.error) {
            alert(window.locale.fileupload.errors[file.error]);
          }
        });
      })//show error
      .bind('fileuploadstarted', function (e, data) {/* ... */})
      .bind('fileuploadsent', function (e, data) {alert('send')})// show waiting...
      .bind('fileuploadcompleted', function (e, data) {/* ... */})
      .bind('fileuploadfailed', function (e, data) {/* ... */})
      .bind('fileuploadstopped', function (e) {/* ... */})
      .bind('fileuploaddestroyed', function (e) {/* ... */});
    });
    </script>
{% endblock %}
