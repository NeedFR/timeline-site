{% extends "timeline/base.html" %}

{% block title %}
  {% if tl %}
    编辑事件 {{tl}}
  {% endif %}
{% endblock %}

{% block extra_header %}
{{block.super}}
<style type="text/css">
  #sb_tl_creater {
    overflow: hidden;
  }
  #sb_tl_creater .user {
    float: left;
  }
  #sb_tl_creater .info ul {
    list-style: none;
    margin: 0 0 0 44px;
  }
  #container_top .sw .label {
    font-size: inherit;
  }
  #container_top .sw {
    float: right;
  }
  .content hr {
    margin: 5px 0;
  }
  textarea {
    height: 120px;
  }
  #id_media, #id_media_caption {
    height: 20px;
  }
  #tl_form_div {
    display: none;
  }
  #btn_add_event {
    float: right;
  }
  .event.cover {
    font-weight: bold;
  }
  #fileupload .uimg img {
  }
</style>
<style type="text/css">
  #insert_tl_img {
    /*width: 280px;*/
  }
  .simple.popover.bottom .arrow {
    left: 80px;
    border-bottom-color: #C6C6C6;
  }
  .simple.popover .popover-tab {
    padding: 4px 6px 0 6px;
    background-color:#F0F0F0;
  }
  .simple.popover .popover-inner {
    background-color:#C6C6C6;
    padding: 1px;
    border-radius: 0;
  }
  .simple.popover .popover-content {
    border-radius: 0;
  }
  .simple.popover .popover-tab p {
    margin: 0px;
  }
  .simple.popover .popover-tab p a {
    display: inline-block;
    height: 26px;
    line-height: 26px;
    margin: 0 -2px;
    padding: 0 11px;
    position: relative;
    z-index: 1;
  }
  .simple.popover .popover-tab .current {
    text-decoration: none;
    cursor: default;
    background: white;
    border: 1px solid #E8E8E8;
    border-bottom: 0;
    -moz-border-radius-topright: 3px;
    -webkit-border-top-right-radius: 3px 3px;
    -moz-border-radius-topleft: 3px;
    -webkit-border-top-left-radius: 3px 3px;
  }
  #fileupload {
    margin: 0;
  }
  #fileupload p {
    padding-bottom: 10px;
  }
</style>
{% endblock %}

{% block sidebar %}
{% endblock %}

{% block container_top %}
<div id="container_top">
  <ul class="sbreadcrumb">
    <li><a href="{% url idx %}">首页</a> <span class="divider">/</span></li>
    <li><a href="{% url timeline_detail tl.pk %}">{{ tl.title }}</a> <span class="divider">/</span></li>
    <li class="active">编辑事件</li>
  </ul>
</div>
{% endblock %}

{% block content %}
  <div class="">
    <div class="">
      <div id="tl_list">
        <table class="table table-striped tllist" style="width=100%">
          <thead>
            <tr>
              <th style="width: 40px"></th>
              <th style="width: 160px">日期</th>
              <th style="width: 260px">标题</th>
              <th>说明</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
        <!-- loadding -->
        <a href="###" class="btn" id="btn_add_event">添加</a>
      </div>
    </div>

    <div class="" id="tl_form_div">
      <div style="width: 640px;float:left;">
        <form action="{% url timeline_addevent_ tl.pk %}" id="tl_form" enctype="multipart/form-data" method="post" class="form-horizontal">
          <fieldset>
            {% csrf_token %}
            <input type="hidden" id="id_pk_" />
            {{form.as_div}}
            <div class="form-actions" class="form-horizontal">
              <p>
                <button type="submit" class="btn btn-primary" id="id_btn_save">保存</button>
                <button type="submit" class="btn" id="id_btn_save_more">保存并继续添加</button>
                <button type="button" id="btn_tlf_cancel" class="btn cancel">取消</button>
              </p>
            </div>
          </fieldset>
        </form>
      </div>
      <div style="">
        .........................................................................
        .........................................................................
        .........................................................................
      </div>
    </div>
  </div>

  <div id="show_tl_img" class="simple popover fade bottom in">
    <div class="arrow"> </div>
    <div class="popover-inner">
      <div class="popover-tab" >
        <a class="close" href="###" onclick="$('#show_tl_img').hide()">×</a>
        <p>
          <a href="###" class="current">媒体文件</a>
        </p>
      </div>
      <div class="popover-content">
      </div>
    </div>
  </div>

  <div id="insert_tl_img" class="simple popover fade bottom in">
    <div class="arrow"> </div>
    <div class="popover-inner">
      <div class="popover-tab" >
        <a class="close" href="###" onclick="$('#insert_tl_img').hide()">×</a>
        <p>
          <a href="###" class="current">本地上传</a>
          <a href="###">已上传图片</a>
        </p>
      </div>
      <div class="popover-content">
        <div> 
          <form id="fileupload" action="" method="POST" enctype="multipart/form-data">
            <div class="fileupload-buttonbar">
              <div class="upload">
                <span class="btn fileinput-button">
                  <i class="icon-upload"></i>
                  <span>上传图片</span>
                  <input type="file" name="file">
                </span>
                &nbsp; <br/> &nbsp;
              </div>
              <div class="uploadding" style="display: none">
                <p>
                  <img src="{{STATIC_URL}}img/loading.gif" />
                  文件上传中，请稍后...
                </p>
                <button type="reset" class="btn cancel">
                  <i class="icon-ban-circle"></i>
                  <span>取消上传</span>
                </button>
              </div>
              <div class="uimg" style="display: none">
                <p> </p>
                <button type="reset" class="btn delete">
                  <i class="icon-remove"></i>
                  <span>删除图片</span>
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block footer_ext %}
  {{ block.super }}
  <script type="text/html" id="events_row_tmpl">
    <tr class="event <% if (cover) { %>cover<% } %>" id="e_<%=pk%>">
      <td>
        <a href="###" class="del">
          <i class="icon-remove"></i>
        </a>
        <a href="###" class="edit">
          <i class="icon-pencil"></i>
        </a>
      </td>
      <td>
        <%=startdate%> 
        <% if (enddate != '') { %> ~ <%=startdate%> <% } %>
      </td>
      <td>
        <%=title%>
        <i class="icon-<%=mediaType%>"></i>
      </td>
      <td><%=text%></td>
    </tr>
  </script>
  <link rel="stylesheet" href="{{STATIC_URL}}bootstrap-datepicker/datepicker.css" type="text/css"/>
  <link rel="stylesheet" href="{{ STATIC_URL }}jQuery-File-Upload/css/jquery.fileupload-ui.css" type="text/css"/>
  <script src='{{STATIC_URL}}js/simple-tpl.js' type='text/javascript'></script>
  <script src='{{STATIC_URL}}bootstrap/js/bootstrap.min.js' type='text/javascript'></script>
  <script type="text/javascript" src="{{ STATIC_URL }}ajax_validation/js/jquery-bootstrap-form.js"></script>
  <script type="text/javascript" src="{{ STATIC_URL }}ajax_validation/js/jquery.djangoajaxform.js"></script>
  <script type="text/javascript" src="{{ STATIC_URL }}bootstrap-datepicker/bootstrap-datepicker.js"></script>
  <script type="text/javascript" src="{{ STATIC_URL }}js/jquery.autosize-min.js"></script>

  <script src="{{ STATIC_URL }}jQuery-File-Upload/js/vendor/jquery.ui.widget.js"></script>
  <script src="{{ STATIC_URL }}jQuery-File-Upload/js/jquery.iframe-transport.js"></script>
  <script src="{{ STATIC_URL }}jQuery-File-Upload/js/jquery.fileupload.js"></script>
  <script src="{{ STATIC_URL }}jQuery-File-Upload/js/jquery.fileupload-fp.js"></script>
  <script src="{{ STATIC_URL }}jQuery-File-Upload/js/jquery.fileupload-ui.js"></script>
  <script src="{{ STATIC_URL }}jQuery-File-Upload/js/locale.js"></script>
  <script type="text/javascript">
    var url_event_delete_ = "{% url event_delete_ %}";
    var url_event_edit_ = "{% url event_edit_ %}";
    var url_event_json_ = "{% url event_json_ %}";
    var url_timeline_addevent_ = "{% url timeline_addevent_ tl.pk %}";
    var url_timeline_events_sjson_ = "{% url timeline_events_sjson_ tl.pk %}";
    var url_media = '';
  </script>
  <script src="{{ STATIC_URL }}js/events.js"></script>
  <script type="text/javascript">
    $(function () {
      var upload = $('#fileupload');
      function showUploadDiv(d) {
        $('.upload, .uploadding, .uimg', upload).hide();
        $(d, upload).show();
      }
      $('.uimg .delete', upload).click(function(){
        var apk = $('.uimg', upload).attr('apk');
        $.post('{% url timeline_attach_delete_ tl.pk %}', {'id': apk}, function(d) {
          if (d.valid) {
            showUploadDiv('.upload');
            $('#id_media').val('');
          } else {
            alert('删除失败');
          }
        }, 'json');
      });

      upload.fileupload();
      upload.fileupload('option', {
          url: "{% url timeline_attach_upload_ tl.pk %}",
          autoUpload: true,
          limitMultiFileUploads: 1,
          maxFileSize: 5000000,
          acceptFileTypes: /(\.|\/)(gif|jpe?g|png)$/i,
          process: [ {
              action: 'load',
              fileTypes: /^image\/(gif|jpeg|png)$/,
              maxFileSize: 5000000
          },
          {
            action: 'save'
          } ]
      });

      upload
      .bind('fileuploadadd', function (e, data) {
        $.each(data.files, function (index, file) {
          if (file.error) {
            alert(window.locale.fileupload.errors[file.error]);
          }
        });
      })
      .bind('fileuploadsubmit', function (e, data) {/* ... */})
      .bind('fileuploadsend', function (e, data) {
        showUploadDiv('.uploadding');
      })
      .bind('fileuploaddone', function (e, data) {
        var d = data.result;
        if (d.valid) {
          var a = d.attachment;
          $('.uimg > p', upload).html('<img src="' + a.url + '"/>');
          $('.uimg', upload).attr('apk', a.id);
          $('#id_media').val(url_media + a.url);
          showUploadDiv('.uimg');
        } else {
          showUploadDiv('.upload');
          alert('图片上传失败');
        }
      })
      .bind('fileuploadfail', function (e, data) {})
      .bind('fileuploadalways', function (e, data) {/* ... */})
      .bind('fileuploadprogress', function (e, data) {/* ... */})
      .bind('fileuploadprogressall', function (e, data) {/* ... */})
      .bind('fileuploadstart', function (e) {/* ... */})
      .bind('fileuploadstop', function (e) {})
      .bind('fileuploadchange', function (e, data) {/* ... */})
      .bind('fileuploadpaste', function (e, data) {/* ... */})
      .bind('fileuploaddrop', function (e, data) {/* ... */})
      .bind('fileuploaddragover', function (e) {/* ... */});
    });
    //done stop stopped
    //fail stop stopped
    </script>
{% endblock %}
